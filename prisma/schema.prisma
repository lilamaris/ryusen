generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Item {
  id             String       @id @default(cuid())
  appId          Int
  contextId      String
  sku            String
  itemKey        String
  name           String
  marketHashName String
  iconUrl        String?
  priceSource    String?
  priceBestBuy   Json?
  priceBestSell  Json?
  priceCachedAt  DateTime?
  holders        BotHasItem[]
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt

  @@unique([appId, contextId, sku])
  @@index([sku])
}

model BotHasItem {
  id         String   @id @default(cuid())
  botId      String
  itemId     String
  amount     Int
  rawPayload Json
  lastSeenAt DateTime
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  bot        Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)
  item       Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)

  @@unique([botId, itemId])
  @@index([itemId])
}

model Bot {
  id                 String             @id @default(cuid())
  name               String             @unique
  steamId            String             @unique
  accountName        String             @unique
  tradeToken         String?
  sharedSecret       String?
  identitySecret     String?
  revocationCode     String?
  onboardingState    BotOnboardingState @default(MANUAL_ONLY)
  onboardingStartedAt DateTime?
  tradeLockedUntil   DateTime?
  session            BotSession?
  backpackIntegration BotBackpackIntegration?
  items              BotHasItem[]
  createdAt          DateTime           @default(now())
  updatedAt          DateTime           @updatedAt
}

model BotBackpackIntegration {
  id                String   @id @default(cuid())
  botId             String   @unique
  accessToken       String
  lastRateLimitedAt DateTime?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  bot               Bot      @relation(fields: [botId], references: [id], onDelete: Cascade)
}

enum BotOnboardingState {
  MANUAL_ONLY
  AUTH_PENDING_CODE
  ONBOARDING_LOCKED
  AUTO_READY
  FAILED
}

model BotSession {
  id            String    @id @default(cuid())
  botId         String    @unique
  sessionToken  String
  webCookies    String[]
  expiresAt     DateTime
  lastCheckedAt DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  bot           Bot       @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@index([expiresAt])
}

enum JobType {
  TRADE_OFFER_CREATE
}

enum JobStatus {
  PENDING
  RUNNING
  RETRY_WAIT
  COMPLETED
  FAILED
  CANCELED
}

model Job {
  id               String          @id @default(cuid())
  type             JobType
  status           JobStatus       @default(PENDING)
  payload          Json
  attemptCount     Int             @default(0)
  maxAttempts      Int
  nextRunAt        DateTime
  claimedBy        String?
  claimExpiresAt   DateTime?
  lastErrorCode    String?
  lastErrorMessage String?
  completedAt      DateTime?
  canceledAt       DateTime?
  transitions      JobTransition[]
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([status, nextRunAt])
  @@index([type, status])
}

model JobTransition {
  id            String    @id @default(cuid())
  jobId         String
  fromStatus    JobStatus
  toStatus      JobStatus
  reasonCode    String?
  reasonMessage String?
  actor         String
  createdAt     DateTime  @default(now())
  job           Job       @relation(fields: [jobId], references: [id], onDelete: Cascade)

  @@index([jobId, createdAt])
}
